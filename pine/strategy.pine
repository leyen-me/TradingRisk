//@version=6
indicator('MACD Volume Strategy (BBO + MACD State, Reversal Type) - Indicator Version', overlay = true)

src = close

// === Volume Oscillator ===
shortlen = input.int(6, minval = 1, title = 'Volume Short Length')
longlen = input.int(12, minval = 1, title = 'Volume Long Length')
shortVol = ta.ema(volume, shortlen)
longVol = ta.ema(volume, longlen)
osc = 100 * (shortVol - longVol) / longVol

// === MACD Calculation ===
fast_length = input(11, title = 'MACD Fast Length')
slow_length = input(21, title = 'MACD Slow Length')
signal_length = input.int(10, title = 'Signal Smoothing')
sma_source = input.string('SMA', title = 'Oscillator MA Type', options = ['SMA', 'EMA'])
sma_signal = input.string('SMA', title = 'Signal Line MA Type', options = ['SMA', 'EMA'])

fast_ma = sma_source == 'SMA' ? ta.sma(src, fast_length) : ta.ema(src, fast_length)
slow_ma = sma_source == 'SMA' ? ta.sma(src, slow_length) : ta.ema(src, slow_length)
macd = fast_ma - slow_ma
signal = sma_signal == 'SMA' ? ta.sma(macd, signal_length) : ta.ema(macd, signal_length)

// === MACD State Check ===
macdAboveSignal = macd > signal
macdBelowSignal = macd < signal

// === BBO Arrow Signals ===
bboBuyArrow = ta.crossover(macd, 0) and osc > 0
bboSellArrow = ta.crossunder(macd, 0) and osc > 0

// === Entry Signals ===
longSignal = bboBuyArrow and macdAboveSignal
shortSignal = bboSellArrow and macdBelowSignal

// === Plot Buy/Sell Arrows on Chart ===
plotshape(longSignal, title="Buy Signal", location=location.belowbar, color=color.green, style=shape.triangleup, size=size.small)
plotshape(shortSignal, title="Sell Signal", location=location.abovebar, color=color.red, style=shape.triangledown, size=size.small)